# Desktop Mate Release Pipeline

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Build and release for multiple platforms
  release:
    name: Release
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact_name: desktop-mate-amd64.AppImage
            os_name: linux
          - os: macos-latest
            artifact_name: Desktop-Mate.dmg
            os_name: macos
          - os: windows-latest
            artifact_name: Desktop-Mate-Setup.exe
            os_name: windows

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm ci

      - name: Build native modules
        run: npm run build:native

      - name: Build application
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Package application
        run: npm run package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.{dmg,exe,AppImage,zip}
            dist/**/*.dmg
            dist/**/*.exe
            dist/**/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and push Docker images
  docker-release:
    name: Docker Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata for Python
        id: meta-python
        uses: docker/metadata-action@v5
        with:
          images: desktopmate/python-sandbox
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Build and push Python image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.python
          push: true
          tags: ${{ steps.meta-python.outputs.tags }}
          labels: ${{ steps.meta-python.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Node.js
        id: meta-nodejs
        uses: docker/metadata-action@v5
        with:
          images: desktopmate/nodejs-sandbox
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Build and push Node.js image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.nodejs
          push: true
          tags: ${{ steps.meta-nodejs.outputs.tags }}
          labels: ${{ steps.meta-nodejs.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Generate release notes
  release-notes:
    name: Release Notes
    runs-on: ubuntu-latest
    needs: [release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const release = context.payload.release;

            // Generate changelog from commits
            const commits = await github.rest.repos.listCommits({
              owner,
              repo,
              per_page: 100,
            });

            const features = [];
            const fixes = [];
            const others = [];

            for (const commit of commits.data) {
              const msg = commit.commit.message.split('\n')[0];
              if (msg.toLowerCase().startsWith('feat')) {
                features.push(msg);
              } else if (msg.toLowerCase().startsWith('fix')) {
                fixes.push(msg);
              } else {
                others.push(msg);
              }
            }

            const notes = `## What's Changed\n\n` +
              `### Features\n${features.map(f => `- ${f}`).join('\n')}\n\n` +
              `### Bug Fixes\n${fixes.map(f => `- ${f}`).join('\n')}\n\n` +
              `### Other\n${others.slice(0, 10).map(o => `- ${o}`).join('\n')}`;

            core.setOutput('notes', notes);

      - name: Update release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notes = `${{ steps.release-notes.outputs.notes }}`;
            const { owner, repo } = context.repo;
            const release = context.payload.release;

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.id,
              body: notes,
            });
